<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢ - Thai Law Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .chat-bubble-user {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            border-radius: 1.5rem 1.5rem 0.5rem 1.5rem;
        }
        .chat-bubble-ai {
            background-color: #ffffff;
            color: #1f2937; /* Gray-800 */
            border-radius: 1.5rem 1.5rem 1.5rem 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Main Container -->
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-2xl flex flex-col h-[90vh]">
        
        <!-- Header -->
        <header class="p-4 border-b bg-gray-50 rounded-t-xl flex justify-between items-center shadow-md">
            <h1 id="app-title" class="text-2xl font-bold text-gray-800">‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢</h1>
            
            <!-- Language Selector -->
            <div class="flex items-center space-x-2">
                <label for="language-select" class="text-sm font-medium text-gray-600 hidden sm:block">‡∏†‡∏≤‡∏©‡∏≤:</label>
                <select id="language-select" class="p-2 rounded-lg border border-gray-300 bg-white shadow-inner focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out cursor-pointer text-sm">
                    <option value="thai">üáπüá≠ ‡πÑ‡∏ó‡∏¢ (Thai)</option>
                    <option value="english">üá∫üá∏ English</option>
                    <option value="chinese">üá®üá≥ ÁÆÄ‰Ωì‰∏≠Êñá (Simplified Chinese)</option>
                </select>
            </div>
        </header>

        <!-- Chat History (Initial greeting will be injected by JavaScript) -->
        <main id="chat-history" class="flex-grow overflow-y-auto p-6 space-y-4">
            <!-- Messages will be injected here -->
        </main>

        <!-- Input Area -->
        <footer class="p-4 border-t bg-gray-50 rounded-b-xl">
            <div class="flex space-x-3">
                <input
                    type="text"
                    id="user-input"
                    class="flex-grow p-3 border border-gray-300 rounded-xl shadow-inner focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                    placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì..."
                    autocomplete="off"
                >
                <button
                    id="send-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition duration-150 ease-in-out transform hover:scale-105 disabled:bg-gray-400 disabled:shadow-none"
                >
                    ‡∏™‡πà‡∏á
                </button>
            </div>
        </footer>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl flex items-center space-x-3">
            <svg class="animate-spin h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="loading-text" class="text-gray-700 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</span>
        </div>
    </div>


    <script>
        // --- Configuration and Constants ---

        // API Key is required for calling the Gemini API
        // *** IMPORTANT: REPLACE THIS EMPTY STRING WITH YOUR ACTUAL GEMINI API KEY ***
        const apiKey = "AIzaSyAhWhtlkYsqmJKkiNuofos2dIcfxJlQXsc"; 
        const apiUrl = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=" + apiKey;
        
        // --- UI Element References ---
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const languageSelect = document.getElementById('language-select');
        const appTitle = document.getElementById('app-title');
        const loadingModal = document.getElementById('loading-modal');
        const loadingText = document.getElementById('loading-text');

        // --- Language Mapping ---
        const LANGUAGES = {
            'thai': {
                code: 'Thai',
                title: '‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢',
                placeholder: '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏≤‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...',
                sendButton: '‡∏™‡πà‡∏á',
                loading: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...',
                greeting: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏î‡∏¥‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢ ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡∏Ñ‡πà‡∏∞ ‡∏ó‡πà‡∏≤‡∏ô‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏î‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏∞?",
                systemPrompt: "You are a highly specialized AI Legal Analyst focusing on Thai Law. Respond to the user's question with accuracy, utilizing search results for grounding. Your response must be generated entirely and clearly in the Thai language."
            },
            'english': {
                code: 'English',
                title: 'Thai Law Assistant',
                placeholder: 'Ask your legal question about Thai Law...',
                sendButton: 'Send',
                loading: 'Processing...',
                greeting: "Hello! I am the Thai Law Assistant, an expert in Thai law ready to provide information and initial guidance. Do you have any questions regarding Thai law?",
                systemPrompt: "You are a highly specialized AI Legal Analyst focusing on Thai Law. Respond to the user's question with accuracy, utilizing search results for grounding. Your response must be generated entirely and clearly in the English language."
            },
            'chinese': {
                code: 'Simplified Chinese',
                title: 'Ê≥∞ÂõΩÊ≥ïÂæãÂä©ÁêÜ',
                placeholder: 'ËæìÂÖ•ÊÇ®ÁöÑÊ≥ïÂæãÈóÆÈ¢ò...',
                sendButton: 'ÂèëÈÄÅ',
                loading: 'Ê≠£Âú®Â§ÑÁêÜ...',
                greeting: "ÊÇ®Â•ΩÔºÅÊàëÊòØÊ≥∞ÂõΩÊ≥ïÂæãÂä©ÁêÜÔºå‰∏Ä‰ΩçÊ≥∞Ê≥ïÂæã‰∏ìÂÆ∂ÔºåÈöèÊó∂ÂáÜÂ§á‰∏∫ÊÇ®Êèê‰æõ‰ø°ÊÅØÂíåÂàùÊ≠•ÊåáÂØº„ÄÇÊÇ®ÂØπÊ≥∞ÂõΩÊ≥ïÂæãÊúâ‰ªÄ‰πàÁñëÈóÆÂêóÔºü",
                systemPrompt: "You are a highly specialized AI Legal Analyst focusing on Thai Law. Respond to the user's question with accuracy, utilizing search results for grounding. Your response must be generated entirely and clearly in the Simplified Chinese language (ÁÆÄ‰Ωì‰∏≠Êñá)."
            }
        };

        let currentLanguage = languageSelect.value;
        let chatHistoryArray = [];

        // --- Core Functions ---

        /**
         * Displays the initial greeting message based on the current language, and resets the chat history.
         */
        function displayInitialGreeting() {
            chatHistory.innerHTML = ''; // Clear the visible chat history
            // Use currentLanguage variable which holds the value from the select box
            const lang = LANGUAGES[currentLanguage]; 
            addMessage('ai', lang.greeting);
        }

        /**
         * Updates all UI elements based on the selected language.
         */
        function updateUI() {
            const lang = LANGUAGES[currentLanguage];
            appTitle.textContent = lang.title;
            userInput.placeholder = lang.placeholder;
            sendButton.textContent = lang.sendButton;
            loadingText.textContent = lang.loading;
        }

        /**
         * Adds a message bubble to the chat history.
         * @param {string} sender - 'user' or 'ai'
         * @param {string} text - The content of the message
         */
        function addMessage(sender, text, sources = []) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = sender === 'user' ? 'flex justify-end' : 'flex justify-start';

            const messageBubble = document.createElement('div');
            messageBubble.className = sender === 'user' 
                ? 'chat-bubble-user p-4 max-w-3xl break-words whitespace-pre-wrap' 
                : 'chat-bubble-ai p-4 max-w-3xl break-words whitespace-pre-wrap';
            
            if (sender === 'ai') {
                const header = document.createElement('p');
                header.className = 'font-semibold text-blue-600 mb-1';
                header.textContent = `${LANGUAGES[currentLanguage].title}:`;
                messageBubble.appendChild(header);
            }

            const textContent = document.createElement('p');
            textContent.innerHTML = text.replace(/\n/g, '<br>'); // Handle newlines
            messageBubble.appendChild(textContent);

            // Add source citations if available
            if (sender === 'ai' && sources.length > 0) {
                const sourcesList = document.createElement('div');
                sourcesList.className = 'mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500';
                // Get translated 'Sources' label
                const sourcesLabel = LANGUAGES[currentLanguage].code === 'Thai' ? '‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≤' : LANGUAGES[currentLanguage].code === 'Simplified Chinese' ? 'Êù•Ê∫ê' : 'Sources';
                sourcesList.innerHTML = `<p class="font-medium mb-1">${sourcesLabel}:</p>`;
                
                sources.slice(0, 3).forEach((source, index) => {
                    const sourceLink = document.createElement('a');
                    sourceLink.href = source.uri;
                    sourceLink.target = '_blank';
                    sourceLink.className = 'block hover:text-blue-600 transition duration-150 ease-in-out truncate';
                    sourceLink.textContent = `${index + 1}. ${source.title || source.uri}`;
                    sourcesList.appendChild(sourceLink);
                });

                messageBubble.appendChild(sourcesList);
            }


            messageWrapper.appendChild(messageBubble);
            chatHistory.appendChild(messageWrapper);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        /**
         * Fetches a response from the Gemini API with exponential backoff for retries.
         * @param {object} payload - The API request body.
         * @param {number} retries - Number of retry attempts left.
         */
        async function fetchWithRetry(payload, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    // Check if API key is set
                    if (!apiKey || apiKey === "") {
                        throw new Error("API Key is missing or empty. Please set the apiKey variable.");
                    }
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        // Throw an error if the status is not 2xx
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`Attempt ${i + 1} failed: ${error.message}`);
                    if (i === retries - 1) throw error; // Re-throw on last attempt
                    const delay = Math.pow(2, i) * 1000; // Exponential backoff (1s, 2s, 4s)
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Handles the sending of a user query to the AI.
         */
        async function sendQuery() {
            const userQuery = userInput.value.trim();
            if (userQuery === "") return;

            // 1. Display user message
            addMessage('user', userQuery);
            userInput.value = '';
            
            // 2. Update and show loading indicator
            sendButton.disabled = true;
            userInput.disabled = true;
            loadingModal.classList.remove('hidden');

            // 3. Prepare API payload
            const systemPrompt = LANGUAGES[currentLanguage].systemPrompt;
            chatHistoryArray.push({ role: "user", parts: [{ text: userQuery }] });

            // CORRECTED PAYLOAD STRUCTURE: Removed the unnecessary 'config' wrapper.
            const payload = {
                contents: chatHistoryArray,
                tools: [{ "google_search": {} }], // Use Google Search for grounding
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                // 4. Call the API
                const result = await fetchWithRetry(payload);
                
                // 5. Process response
                const candidate = result.candidates?.[0];
                let aiResponseText = "An error occurred while generating the response.";
                let sources = [];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    aiResponseText = candidate.content.parts[0].text;
                    
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                }
                
                // 6. Update chat history array and display AI message
                chatHistoryArray.push({ role: "model", parts: [{ text: aiResponseText }] });
                addMessage('ai', aiResponseText, sources);

            } catch (error) {
                console.error("API Call Error:", error);
                const errorMessage = LANGUAGES[currentLanguage].code === 'Thai' 
                    ? '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á' 
                    : LANGUAGES[currentLanguage].code === 'Simplified Chinese'
                    ? 'ÂØπ‰∏çËµ∑ÔºåËøûÊé•Êó∂ÂèëÁîüÈîôËØØÔºåËØ∑ÂÜçËØï‰∏ÄÊ¨°„ÄÇ'
                    : 'Sorry, an error occurred during the connection. Please try again.';

                addMessage('ai', errorMessage);
            } finally {
                // 7. Hide loading and re-enable inputs
                loadingModal.classList.add('hidden');
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        // --- Event Listeners ---

        // Language selector change
        languageSelect.addEventListener('change', (event) => {
            currentLanguage = event.target.value;
            updateUI();
            
            // Clear history and reset context for the new language conversation
            chatHistoryArray = []; 
            displayInitialGreeting(); // Display the newly translated greeting
        });

        // Send button click
        sendButton.addEventListener('click', sendQuery);

        // Enter key press in the input field
        userInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter' && !sendButton.disabled) {
                sendQuery();
            }
        });

        // Initialize UI and display initial greeting on load
        window.onload = () => {
            updateUI();
            displayInitialGreeting();
            userInput.focus();
        };

    </script>
</body>
</html>